{% extends 'payments/base.html' %}
{% load static %}

{% block title %}Checkout{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'payments/styles.css' %}">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8 text-center">Checkout</h1>
    <form id="payment-form" class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-lg">
        <div class="mb-4">
            <label for="name" class="block text-gray-700">Name on Card</label>
            <input type="text" id="name" name="name" value="{{ payment.Name }}" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
        </div>
        <div class="mb-4">
            <label for="email" class="block text-gray-700">Email</label>
            <input type="email" id="email" name="email" value="{{ payment.Email }}" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
        </div>
        <div class="mb-4">
            <label for="amount" class="block text-gray-700">Total Amount</label>
            <input type="number" id="amount" name="total_amount" value="{{ total_amount }}" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
        </div>
        <div class="mb-4">
            <label for="zipcode" class="block text-gray-700">Zip Code</label>
            <input type="text" id="zipcode" name="zipcode" value="{{ payment.zipcode }}" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
        </div>
        <div id="card-element" class="mb-4">
            <!-- A Stripe Element will be inserted here. -->
        </div>
        <div id="card-error" role="alert" class="text-red-500"></div>
        <button id="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition duration-300">Pay</button>
    </form>
</div>

<script>
    // Initialize Stripe
    var stripe = Stripe('{{ STRIPE_PUBLISHABLE_KEY }}'); // Replace with your Stripe publishable key
    var elements = stripe.elements();

    // Create an instance of the card Element
    var cardElement = elements.create('card', {
        hidePostalCode: true
    });

    // Add an instance of the card Element into the `card-element` <div>
    cardElement.mount('#card-element');

    // Handle real-time validation errors from the card Element
    cardElement.on('change', function(event) {
        var displayError = document.getElementById('card-error');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });

    // Handle form submission
    var form = document.getElementById('payment-form');
    form.addEventListener('submit', function(event) {
        event.preventDefault();

        stripe.confirmCardPayment('{{ payment_intent_client_secret }}', {
            payment_method: {
                card: cardElement,
                billing_details: {
                    name: form.querySelector('input[name="name"]').value,
                    email: form.querySelector('input[name="email"]').value,
                }
            }
        }).then(function(result) {
            if (result.error) {
                // Show error to your customer (e.g., insufficient funds)
                window.location.href = "{% url 'payments:payment_failed' %}";
            } else {
                // The payment succeeded!
                window.location.href = "{% url 'payments:payment_success' %}";
            }
        });
    });
</script>
{% endblock %}